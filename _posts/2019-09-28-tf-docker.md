---
layout: post
title: å¦‚ä½•éƒ¨ç½²tensorflow dockerç¯å¢ƒ
category: machine-learning
---

# èƒŒæ™¯

æœ€è¿‘çš„é¡¹ç›®ï¼Œæ¶‰åŠåˆ°tensorflowçš„ç”Ÿäº§ç¯å¢ƒçš„éƒ¨ç½²ï¼Œè¿˜å¾—ä¸Šdockerï¼Œæ‰€ä»¥ï¼Œæˆ‘å°±å¼€å§‹äº†é¡¹ç›®éƒ¨ç½²çš„æŠ˜è…¾ä¹‹æ—…ã€‚

è¿™é‡Œæ¶‰åŠåˆ°åˆ°å¾ˆå¤šåŸºç¡€çš„æ¦‚å¿µï¼Œæ¯”å¦‚dockeré•œåƒã€dockerå®¹å™¨ã€dockeræœåŠ¡ç¼–æ’ã€tensorflowçš„GPUæ”¯æŒã€pythonçš„æœ¬åœ°å®‰è£…setuptoolsç­‰è¯¸å¤šåŸºæœ¬æ¦‚å¿µå’ŒçŸ¥è¯†ï¼Œå°±ä¸ç»™ç§‘æ™®äº†ï¼Œå‡è®¾ä½ éƒ½å·²ç»æœ‰äº†å¤§è‡´çš„äº†è§£ï¼Œè¿™é‡Œä¸»è¦è®²ä¸€ä¸‹æˆ‘çš„æ¢å‘ä¹‹æ—…ã€‚

# åŸºæœ¬baseé•œåƒ

å…ˆå¾—æœ‰ä¸ªèƒ½è·‘tensorflowçš„ç¯å¢ƒæŠŠï¼Œå¥½ï¼Œå°±å¾—å…ˆæä¸ªåŸºç¡€çš„èƒ½è®¤å‡ºGPUçš„tensorflowçš„ç¯å¢ƒå§ï¼Œè¿™ä¸ªå¯æ˜¯åŸºç¡€å•Šã€‚

## nvidiaé©±åŠ¨ï¼ŒCUDAï¼ŒCUDNNï¼Œdockerï¼Œnvidia-docker

è¿™äº‹å„¿æŒºçº ç»“çš„ï¼Œè€Œä¸”ä¹Ÿèµ°äº†ä¸€äº›å¼¯è·¯ï¼Œå¼€å§‹å•Šï¼Œæˆ‘å…¶å®æ²¡å¤ªææ¸…æ¥šï¼Œnvidiaé©±åŠ¨ï¼ŒCUDAï¼ŒCUDNNï¼Œdockerï¼Œnvidia-dockerçš„å…³ç³»ã€‚æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œå¦‚æœæ˜¯ç›´æ¥åœ¨æ“ä½œç³»ç»Ÿé‡Œé¢è£…tensorflow-gpuï¼Œå°±å¾—å…ˆè£…nvidiaé©±åŠ¨ï¼Œç„¶åè£…CUDAï¼Œç„¶åå†è£…CuDNNï¼Œç„¶åæœ€åæ‰èƒ½è£…tensorflow-gpuçš„pipåŒ…ï¼Œè¿˜ä¸èƒ½è£…tensorflowï¼Œå¿…é¡»è£…-gpuç‰ˆæœ¬ï¼Œæ‰å¯ä»¥çœŸæ­£è·‘èµ·æ¥tensorflowçš„gpuè®­ç»ƒã€‚å¯æ˜¯ï¼Œåˆ°äº†dockerçš„ä¸–ç•Œï¼Œæ”¹æ€ä¹ˆåŠå‘¢ï¼Ÿ

è¿™é‡Œæœ‰å¼ å›¾ï¼Œå¯è€»çš„ğŸ˜ˆç›—ç”¨ä¸€ä¸‹ï¼š

![](/images/20191007/cuda-tf-docker.png)

ä¸€å›¾èƒœåƒè¨€å•Šï¼Œå¾ˆæ˜ç™½ï¼Œå°±æ˜¯ä½ åœ¨å®¿ä¸»æœºé‡Œï¼Œä¹Ÿå°±æ˜¯è·‘dockeræœåŠ¡çš„é‚£ä¸ªå®¿ä¸»æ“ä½œç³»ç»Ÿé‡Œé¢ï¼Œåªéœ€è¦è£…ä¸ªnvidiaé©±åŠ¨å°±å®Œäº†ï¼Œå•Šï¼è¿™ä¹ˆç®€å•å•Šï¼Ÿï¼å¯¹ï¼Œå°±é…±ç´«ï¼Œå®Œäº‹ã€‚

é‚£CUDAã€CuDNNé‚£äº›å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼Œåœ¨é•œåƒimageé‡Œé¢ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ è¦æ˜¯æƒ³è®©ä¸€ä¸ªdockerå®¹å™¨æœªæ¥è·‘èµ·æ¥å¯ä»¥æ”¯æŒtensorflowå»ä½¿ç”¨æ˜¾å¡ï¼Œä½ å¾—æä¸€ä¸ªåŒ…å«äº†CUDAå’ŒCuDNNçš„imagesé•œåƒï¼Œç„¶åå†åœ¨è¿™é‡Œé¢è£…ä¸ªtensorflow-gpuå°±å¯ä»¥äº†ã€‚

å“¦ï¼

ä¸è¿‡ï¼Œä½ ä»¥ä¸ºå°±å®Œäº†ä¹ˆï¼Ÿå¹¶æ²¡æœ‰ã€‚ğŸ¤¡

ä½ å¦‚æœå»ç”¨docker run å»è·‘ä»–ï¼Œè¿˜æ˜¯ä¸è¡Œï¼Œè¿˜æ˜¯è®¤ä¸å‡ºæ˜¾å¡æ¥ã€‚è¿™ä¸ªæ—¶å€™ï¼Œä½ è¿˜éœ€è¦å®‰è£…nvidiaå…¬å¸çš„dockerçš„ä¸€ä¸ªè¾…åŠ©åŒ…ï¼Œå«nvidia-dockerï¼Œè¿™ä¸ªæ˜¯ä¸ªyum/aptåŒ…ï¼Œè£…å®Œåï¼Œå°±å¯ä»¥è®©dockeræ”¯æŒæ˜¾å¡å•¦ã€‚

nvidia-docker v1çš„æ—¶å€™ï¼Œä½ å¾—ç”¨ä¸€ä¸ªæ–°å‘½ä»¤å»è·‘dockerï¼š`nvidia-docker run myimg`ï¼Œåˆ°äº† nvidia-docker v2çš„æ—¶å€™ï¼Œå°±èˆ’æœå¤šäº†ï¼š`docker run --runtime=nvidia myimg`å°±å¯ä»¥äº†ï¼Œçˆ½äº†å§ã€‚

æ€»ç»“ä¸€ä¸‹ï¼Œå°±æ˜¯ï¼Œä¸ºäº†è·‘ä¸€ä¸ªæ”¯æŒGPUæ˜¾å¡çš„dockerï¼ŒçœŸTMDè´¹åŠ²ï¼
- å¾—åœ¨dockeræœåŠ¡çš„å®¿ä¸»æœºä¸Šè£…nvidiaé©±åŠ¨
- åœ¨å®¿ä¸»æœºä¸Šï¼Œè¿˜å¾—è£… nvidia-docker
- å¾—æä¸ªè£…äº†CUDAå’ŒCuDNNçš„imageé•œåƒ
- æœ€åï¼Œåœ¨é•œåƒé‡Œé¢ï¼Œåˆ«å¿˜äº†å¾—è£…tensorflow-gpuç‰ˆæœ¬
- æœ€æœ€åï¼Œè·‘èµ·æ¥dockerå®¹å™¨çš„æ—¶å€™ï¼Œåˆ«å¿˜äº†åŠ ä¸Š --runtime=nvidiaå‚æ•°

ä¸è¿‡ï¼Œè¿™ä¸ªéƒ½æ˜¯æˆ‘æ„æ·«çš„ï¼Œæˆ‘å¹¶æ²¡æœ‰è¿™ä¹ˆåšï¼Œæˆ‘åªæ˜¯docker pull tensorflow/tensorflow:1.14.0-gpu-py3äº†ä¸€ä¸‹ï¼Œå°±æŠŠè¿™ä¸ªè¿‡ç¨‹éƒ½çœç•¥äº†ï¼Œå“ˆå“ˆï¼Œæˆ‘å°±æ˜¯è¿™ä¹ˆæ— è€»ï¼

## å¥½å§ï¼Œæˆ‘è¯´è¯´æˆ‘çš„webæœåŠ¡é•œåƒåˆ¶ä½œäº†

æœ‰äº†ä¸€ä¸ªå¥½çš„åŸºå‡†imageï¼Œè¿˜æ²¡å®Œã€‚ç”Ÿäº§ç¯å¢ƒï¼Œå¯æ˜¯ä¸èƒ½è”ç½‘çš„ï¼Œæ‰€ä»¥æˆ‘è¦æŠŠèƒ½è£…çš„pipå•¥çš„éœ€è¦è”ç½‘çš„ä¸œä¸œï¼Œéƒ½è¦å¡è¿›è¿™ä¸ªåŸºå‡†baseé•œåƒé‡Œã€‚

æ‰€ä»¥ï¼Œæˆ‘éœ€è¦è§£å†³å‡ ä¸ªé—®é¢˜ï¼š
- è¦æŠŠaptæºæ¢æˆé˜¿é‡Œçš„ï¼Œè¿™æ ·åç»­å°±å¯ä»¥`apt-get install`çˆ½çˆ½çš„è£…äº†
- è¿˜è¦æŠŠè¯­è¨€ç¯å¢ƒæ”¹æˆä¸­æ–‡
- è¦æŠŠé¡¹ç›®ä¸­ä¾èµ–çš„pipåŒ…éƒ½å…¨å®¶æ¡¶è£…å¥½ï¼Œå¹¶ä¸”å®‰è£…è¿‡ç¨‹ä¸­ä½¿ç”¨è±†ç“£çš„pipæºï¼Œè¿™æ ·æ‰å¯ä»¥çˆ½

å¥½å§ï¼Œçœ‹æœ€åçš„[Dockerfile](https://github.com/piginzoo/ocr/blob/master/config/Dockerfile.base).

docker buildï¼Œå®Œæˆï¼

# åˆ¶ä½œWebæœåŠ¡é•œåƒ

å¥½ï¼Œæœ‰äº†åŸºå‡†é•œåƒimageï¼Œè¦å¼€å§‹åœ¨å…¶åŸºç¡€ä¸Šï¼Œåˆ¶ä½œæˆ‘ä»¬çš„WebæœåŠ¡é•œåƒäº†ã€‚

ä¸è¿‡ï¼Œæˆ‘ä»¬é¦–å…ˆè¦è°ƒæ•´ä¸€ä¸‹æˆ‘ä»¬çš„ä»£ç ç»“æ„ï¼š

## å…ˆæ”¹é€ ä»£ç ç»“æ„

ä¹‹å‰ï¼Œæ˜¯3ä¸ªé¡¹ç›®åˆ†å¼€çš„ï¼Œä¸€ä¸ªCTPNï¼Œä¸€ä¸ªCRNNï¼Œä¸€ä¸ªWebã€‚å¤ªæ•£äº†ã€‚æˆ‘åªå¥½ç”¨å¾ˆè¹©è„šçš„è„šæœ¬ï¼Œåœ¨è·¯å¾„ä¸­æ·»åŠ äº†ä»–ä¿©çš„è·¯å¾„ï¼Œå¥½è®©è§£é‡Šå™¨å¯ä»¥æ‰¾åˆ°ä»–ä»¬ã€‚

```
conf.py
CTPN_HOME=['ctpn']
CRNN_HOME=['crnn']

# ä¸ºäº†é›†æˆé¡¹ç›®,æŠŠCTPNå’ŒCRNNé¡¹ç›®çš„ç»å¯¹è·¯å¾„åŠ åˆ°pythonç±»è·¯å¾„é‡Œé¢
for path in conf.CRNN_HOME+conf.CTPN_HOME:
    sys.path.insert(0, os.path.join(os.path.abspath(os.pardir), path))
sys.path.append(".")
# å®Œäº‹äº†ï¼Œæ‰å¯ä»¥import ctpnï¼Œå¦åˆ™æŠ¥é”™
import main.pred  as ctpn
import tools.pred as crnn
```

æˆ‘ä¸€ç›´æœ‰ä¸ªå¿ƒæ„¿ğŸ™ï¼Œå°±æ˜¯ç”¨pythonçš„setuptoolsï¼ŒæŠŠctpnã€crnnè¿™ä¸¤ä¸ªé¡¹ç›®ææˆä¸€ä¸ªæœ¬åœ°å®‰è£…çš„libraryçš„æ¦‚å¿µï¼Œè¿™æ ·å°±å¯ä»¥å¿ƒå®‰ç†å¾—çš„importäº†ã€‚ç»ˆäºï¼Œå€Ÿè¿™ä¸ªéƒ¨ç½²dockerçš„å¥‘æœºï¼Œæä¸€æŠŠã€‚

äºæ˜¯ï¼Œæˆ‘æœæ–­çš„å¼€å§‹ä¹¦å†™crnnçš„[setup.py](https://github.com/piginzoo/ocr/blob/master/crnn/setup.py)å’Œctpnçš„[setup.py](https://github.com/piginzoo/ocr/blob/master/ctpn/setup.py)ï¼Œè¿‡ç¨‹ä¸­å¾ˆå¤šé—®é¢˜ï¼Œä¹Ÿæœ‰å¾ˆå¤šæ”¶è·ï¼š
- æˆ‘ä»¥ä¸ºç”ŸæˆeggåŒ…ï¼Œå°±æ˜¯æˆ‘çš„åŒ…çš„åå­—ï¼Œæ¯”å¦‚ç”Ÿæˆçš„å«ctpn.eggçš„åŒ…ï¼Œé‚£ä¹ˆæˆ‘å°±å¯ä»¥`import ctpn`ï¼Œå¼•å…¥åˆ°æˆ‘æ‰€éœ€è¦çš„ä½ç½®äº†ã€‚å…¶å®æ˜¯ä¸è¡Œçš„ï¼Œä½ å¿…é¡»è¿˜è¦åœ¨ctpnè¿™ä¸ªåŒ…é‡Œé¢ï¼Œå¢åŠ ä¸€ä¸ªctpnçš„æ–‡ä»¶å¤¹ï¼Œç„¶åæŠŠæ‰€æœ‰çš„pyæºç æ”¾åˆ°åˆ°è¿™ä¸ªç›®å½•ä¸­ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªctpnæ–‡ä»¶å¤¹ï¼Œæ‰æ˜¯çœŸæ­£æ‹…å½“äº†`import ctpn.xxx`çš„åŒ…åçš„ä½œç”¨
- find_packageså¾ˆçˆ½ï¼Œä¸€å¥`packages=find_packages(where='.', exclude=(), include=('*',))`ï¼Œå°±æŠŠæ‰€æœ‰çš„ä»£ç éƒ½æ‰¾åˆ°äº†ï¼Œæ”¾åˆ°äº†eggåŒ…ä¸­
- ctpnä¸­æœ‰2ä¸ªc++çš„ç¨‹åºï¼Œéœ€è¦å•ç‹¬ç¼–è¯‘å¹¶å®‰è£…æˆä¸€ä¸ªå•ç‹¬çš„åŒ…ï¼Œå¯¹ï¼Œå•ç‹¬çš„åŒ…ï¼Œæœ¬æ¥ï¼Œæˆ‘è¿˜å¹»æƒ³ï¼Œæˆ‘çš„ctpnçš„pythonä»£ç çš„eggåŒ…ï¼Œå¯ä»¥å’Œè¿™ä¸ªc++ç¨‹åºä»¬åœ¨ä¸€ä¸ªåŒ…ä¸­ï¼Œåæ¥å‘ç°ï¼Œç”Ÿæˆçš„eggæ–‡ä»¶ï¼ˆå…¶å®ä¸«å°±æ˜¯ä¸€ä¸ªzipåŒ…ï¼‰ï¼Œæ­»æ´»ç»Ÿä¸€ä¸åˆ°ä¸€èµ·ã€‚æˆ‘çš„pythonä»£ç ç”ŸæˆeggåŒ…å«`ctpn-1.0-py3.6.egg`ï¼Œå¯ä»¥ï¼Œc++ç¨‹åºç”Ÿæˆçš„åŒ…å«`ctpn-1.0-py3.6-macosx-10.6-intel.egg`ï¼Œä¸ºæ¯›ï¼Œéè¦æœ‰ä¸ªmacosx-10.6-intelè¿™ä¸ªé¬¼å‘¢ï¼Ÿï¼æ­»æ´»æ¶ˆé™¤ä¸æ‰ï¼Œè€Œä¸”ï¼Œä»–è¿˜å¿…é¡»æ˜¯ç›®å½•ç»“æ„ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªzipåŒ…ï¼Œæ©ï¼Œçº ç»“åï¼Œæˆ‘ç»ˆäºæ”¾å¼ƒäº†ã€‚è¸è¸å®å®ä¸ºä»–ä»¬å„è‡ªåšä¸€ä¸ªåŒ…ï¼Œè€Œä¸”ï¼Œæ›´æ‹§å·´çš„æ˜¯ï¼Œä½ è¿˜å¾—ä¸ºé‡Œé¢çš„`nms.py`å•ç‹¬ç”Ÿæˆä¸€ä¸ª`ctpn_bbox`çš„åŒ…ï¼Œä¸èƒ½ç”¨ç»Ÿä¸€æˆ`ctpn`åŒ…ï¼Œå¦åˆ™ï¼Œè¿™ä¸ªåŒ…ä¼šå¼ºå äº†ctpnè¿™ä¸ªåŒ…çš„åå­—ï¼Œå¯¼è‡´ä½ æ‰¾ä¸åˆ°å…¶ä»–pythonæ–‡ä»¶å•¦ã€‚çœŸå¿ƒçº ç»“ğŸ˜­ã€‚
æ¥çœ‹çœ‹ï¼Œæœ€åçš„C++åŠ¨æ€åº“ç›¸å…³çš„eggç›®å½•ç»“æ„ï¼š
```
ctpn_bbox-1.0-py3.6-macosx-10.6-intel.egg/ctpn_bbox
â”œâ”€â”€ __pycache__
â”‚Â Â  â””â”€â”€ nms.cpython-36.pyc
â”œâ”€â”€ bbox.cpython-36m-darwin.so
â”œâ”€â”€ nms.cpython-36m-darwin.so
â””â”€â”€ nms.py
```
- æ©ï¼Œc++çš„ä»£ç æ˜¯é cythonizeæå®šçš„ï¼Œæˆ‘å¼€å§‹å› ä¸ºæ˜¯äººå®¶å…ˆå†™äº†ä¸€ä¸ªc++ç¨‹åºï¼Œç„¶åç¼–è¯‘æˆsoåº“ï¼Œç„¶åå†ç”Ÿæˆä¸€ä¸ªpythonä»£ç ï¼Œè¢«æˆ‘ä»¬è°ƒç”¨çš„ï¼Œå…¶å®æˆ‘é”™äº†ï¼Œcythonizeçš„ç©æ³•æ˜¯ï¼Œä½ å…ˆå†™pythonä»£ç ï¼Œç„¶åä»–æŠŠä½ çš„pythonä»£ç ç¿»è¯‘æˆc++ä»£ç ï¼Œç„¶åä½ ç¼–è¯‘c++ç¨‹åºç”Ÿæˆsoæ–‡ä»¶å°±å¯ä»¥å•¦ã€‚
>[Cythonåº“](https://www.cnblogs.com/jianmu/p/7497274.html)æ­£å¥½ç¬¦åˆè¿™ç§åœºæ™¯éœ€æ±‚ï¼Œå°†å·²æœ‰çš„Pythonä»£ç è½¬åŒ–ä¸ºCè¯­è¨€çš„ä»£ç ï¼Œå¹¶ä½œä¸ºPythonçš„built-inæ¨¡å—æ‰©å±•ã€‚å…¶æœ€é‡è¦çš„åŠŸèƒ½æ˜¯ï¼š
>write Python code that calls back and forth from and to C or C++ code natively at any point.
>å³ å°†Pythonä»£ç ç¿»è¯‘ä¸ºCä»£ç ã€‚ä¹‹åå°±å¯ä»¥åƒå‰é¢æ–‡ç« ä»‹ç»çš„Cè¯­è¨€æ‰©å±•Pythonæ¨¡å—ä½¿ç”¨è¿™äº›Cä»£ç äº†ã€‚
>æˆ‘çš„ç†è§£ï¼šè¿™ä¸ªæ˜¯pythonä»£ç =>cä»£ç ï¼Œç„¶åç¼–è¯‘ï¼Œç„¶åå†ç”¨pythonè°ƒç”¨soï¼Œä¸æ˜¯æˆ‘ç†è§£çš„ç”¨cä»£ç å†™åŠŸèƒ½ï¼Œè€Œæ˜¯ç”¨pythonå†™ï¼Œè½¬æˆcã€‚

- crnnè™½ç„¶æ²¡æœ‰c++ä»£ç ï¼Œä½†æ˜¯ä¾ç„¶ç”Ÿæˆä¸€ä¸ª\*.eggç»“å°¾çš„æ–‡ä»¶å¤¹ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªzipæ–‡ä»¶ï¼Œä¸ºä½•å‘¢ï¼ŸåŸå› æ˜¯ï¼Œä»–éœ€è¦åŒ…å«èµ„æºæ–‡ä»¶ï¼Œæ‰€ä»¥ä½¿ç”¨package_dataï¼š`package_data={'crnn.config':['charset.3770.txt','charset.5987.txt','charset.6883.txt']}`ï¼Œæˆ‘ä»¬æŠŠèµ„æºæ–‡ä»¶æ”¾åˆ°äº†eggé‡Œï¼Œä¹Ÿå°±å¯¼è‡´äº†ï¼Œå®‰è£…å®Œçš„eggæ˜¯ä¸€ä¸ªæ–‡ä»¶äº†ï¼Œè€Œä¸æ˜¯zipæ–‡ä»¶äº†ã€‚

å¥½å§ï¼Œç»ˆäºæŠ˜è…¾å¥½äº†ï¼Œç„¶åä¸€ä¸ªpython setup.pyå°±æŠŠctpnã€crnnéƒ½è£…åˆ°äº†æœ¬åœ°çš„åº“é‡Œé¢äº†ï¼Œä¸–ç•Œæ¸…é™äº†ğŸ’€....

## ç»ˆäºå¯ä»¥å¼€å§‹æ„å»ºWebé•œåƒäº†

æœ‰äº†é‚£ä¸ªå¯ä»¥è·‘tensorflow-gpuã€è¿˜å¡«æ»¡äº†å„ç§éœ€è¦çš„pipåŒ…çš„åŸºå‡†baseé•œåƒï¼Œåœ¨åŠ ä¸Šæˆ‘æå¥½çš„æ‹é¡ºçš„ä»£ç ç»“æ„ï¼Œ**ç»ˆäºå¯ä»¥åˆ¶ä½œæˆ‘çš„é•œåƒäº†**ã€‚

æˆ‘è¦æ2ä¸ªç‰ˆæœ¬ï¼š

1ã€å¯ä»¥è°ƒç”¨tensorflow-servingçš„dockerçš„dockerï¼Œç»•å£å“ˆï¼Œå°±æ˜¯ä»–åªæ˜¯ä¸ªwebç¨‹åºï¼Œæ¨¡å‹æ˜¯ç”±tensorflow-serving dockeråŠ è½½çš„ã€‚

2ã€å¯ä»¥è‡ªå·±åŠ è½½æ¨¡å‹ï¼Œå¹¶ä¸”å¯ä»¥å¯¹å¤–æœåŠ¡ï¼Œæœ¬è´¨å°±æ˜¯tensorflowæ¨¡å‹é¢„æµ‹+webç¨‹åºçš„åˆä½“

ä½ é—®æˆ‘ï¼Œæˆ‘ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆæï¼Ÿ

æˆ‘å°±æ˜¯è§‰å¾—è¿™æ ·çˆ½ï¼Œæˆ‘è¦å„ç§æƒ…å†µéƒ½è¦æ”¯æŒå•Šï¼šæ—¢æ”¯æŒtensorflowå•ç‹¬è·‘çš„æ–¹å¼ï¼Œä¹Ÿæ”¯æŒå’Œtensorflow-servingé›†æˆçš„æ–¹å¼è·‘ã€‚å¯¹äº†ï¼Œå…³äºtensorflow-servingçš„è¶Ÿå‘ä¹‹æ—…ï¼Œå¯ä»¥å‚è€ƒæˆ‘çš„[è¿™ç¯‡](/machine-learning/2019/09/17/tf-serving)ã€‚æˆ‘ç”šè‡³ï¼Œè¿˜å¯ä»¥è®©ä»£ç æ”¯æŒä¸ç”¨dockerçš„æ–¹å¼è·‘ï¼Œæ–¹ä¾¿è°ƒè¯•å˜›ã€‚

å¥½å•¦ï¼Œå¥‡æ€ªçš„åºŸè¯ä¸è¯´äº†ï¼Œç»§ç»­ã€‚

å…¶å®ï¼Œåˆ¶ä½œWebé•œåƒï¼Œå¹¶æ²¡æœ‰å¤ªå¤šéœ€è¦è¯´çš„åœ°æ–¹ï¼Œå°±åªæ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š
- git pullä»£ç è¿™äº‹ï¼Œæˆ‘æ˜¯ä¸ç®¡çš„ï¼Œä¸åœ¨å®¹å™¨é‡Œgit pullï¼Œä¸å¥½ï¼Œäº¤ç»™å¤–é¢å»ï¼Œäº¤ç»™è¿ç»´çš„åŒå¿—ä»¬å»æ
- æ‰€ä»¥ï¼Œæˆ‘è¦åšçš„å°±æ˜¯æŠŠä»£ç ADDåˆ°é•œåƒé‡Œå³å¯
- ç„¶åè¦è¿è¡Œäº†c++çš„åº“çš„ç¼–è¯‘å®‰è£…è¿‡ç¨‹ï¼Œæˆ‘æäº†ä¸ªinstall.shï¼Œè¿è¡Œä¸€ä¸‹å³å¯

ä¾ç„¶ï¼Œ`docker build`ï¼Œè¿è¡Œï¼Œæ—¢å¯ä»¥ï¼Œç”Ÿæˆæˆ‘ä»¬éœ€è¦çš„ocr.webé•œåƒå•¦ã€‚

å¥½å§ï¼Œçœ‹æœ€åçš„[Dockerfile](https://github.com/piginzoo/ocr/blob/master/config/Dockerfile).

# å®¹å™¨å¯åŠ¨

ç»ˆäºç»ˆäºï¼Œå¯ä»¥æŠŠç¨‹åºè·‘èµ·æ¥å•¦ï¼Œå¥½å¼€æ£®å•Šã€‚ğŸ¤ª

## å…¨é ç¯å¢ƒå˜é‡ä¼ å…¥å‚æ•°

è®°å¾—ä¸ï¼Ÿæˆ‘è¯´è¿‡ï¼Œæˆ‘çš„ç¨‹åºè¦èƒ½å•ç‹¬è·‘ï¼Œä¹Ÿèƒ½å’Œtensorflow-servingé…åˆè·‘ï¼›å¯ä»¥åœ¨å®¹å™¨é‡Œé¢è·‘ï¼Œè¿˜è¦å¯ä»¥ä¸ç”¨å®¹å™¨ä¹Ÿå¯ä»¥è·‘ï¼ˆè°ƒè¯•ç”¨ï¼‰ã€‚ä¸ºäº†æ»¡è¶³ä¸Šè¿°å„ç§æ–¹å¼ï¼Œæˆ‘ä¹Ÿæ‹§å·´äº†ä¸€é˜µã€‚

å¼€å§‹æˆ‘æ˜¯åœ¨Webçš„å¯åŠ¨è„šæœ¬é‡Œï¼ŒåŠ äº†ä¸€å †çš„å¯åŠ¨å‚æ•°ã€‚ä½¿ç”¨linuxæœ¬èº«è‡ªå¸¦çš„[getopt](http://witmax.cn/shell-mac-parse-parameters.html)ã€‚å¯¹äº†ï¼Œlinuxè¿˜å¸¦ä¸€ä¸ªgetoptsï¼Œè™½ç„¶å¤šäº†ä¸ªsï¼Œä½†æ˜¯ä¸å¦‚getoptå¥½ç”¨ï¼Œä¸»è¦æ˜¯ä¸æ”¯æŒé•¿å‚æ•°ï¼ˆä¾‹å¦‚--mode=xxxxï¼‰ã€‚å¦å¤–ï¼Œmacçš„getoptå’Œlinuxçš„ï¼Œè¿˜ä¸å¤ªä¸€æ ·ï¼Œä¼šå¯¼è‡´ä½ å¼€å‘è¿‡ç¨‹æœ‰é—®é¢˜ï¼Œè§£å†³ä¹‹é“æ˜¯è£…ä¸€ä¸ªgnu-getopt:`brew install gnu-getopt`ã€‚ç„¶åï¼Œæˆ‘æƒ³åœ¨å®¹å™¨å¯åŠ¨çš„æ—¶å€™ï¼Œä¼ ç»™å®¹å™¨ä¸åŒçš„å‚æ•°ï¼Œæ¥åŠ¨æ€å†³å®šæ˜¯å•ç‹¬è·‘è¿˜æ˜¯å’Œtensorflow-servingé›†æˆï¼Œå¤šå¥½å•Šã€‚

ä½†æ˜¯ï¼Œç°å®æ˜¯æ®‹é…·çš„ã€‚è¦å¾€runtimeçš„å®¹å™¨é‡Œé¢ä¼ å…¥å‚æ•°ï¼Œåªèƒ½é€šè¿‡ç¯å¢ƒå˜é‡ï¼Œé ï¼è‹¦æ¼æ­»äº†ã€‚åªå¥½è°ƒæ•´æˆ‘çš„å¯åŠ¨shellè„šæœ¬ï¼Œéƒ½æ”¹æˆäº†ä¼ å…¥ç¯å¢ƒå˜é‡ï¼Œè€Œä¸”ï¼Œè¿˜å¾—æ”¹pythonè„šæœ¬ï¼Œä»ç¯å¢ƒå˜é‡é‡Œé¢è¯»å–å„ç§å‚æ•°ï¼Œå…¶ä¸­æŠ˜è…¾å’Œæ»‹å‘³å°±ä¸è¯´äº†ã€‚

ç°åœ¨çš„WebæœåŠ¡å¯åŠ¨è„šæœ¬å˜æˆäº†è¿™ä¸ªæ ·å­:[server.sh](https://github.com/piginzoo/ocr/blob/master/ocr/bin/server.sh)ã€‚

æœ€ç»ˆæˆ‘ä»¬å®šä¹‰äº†2ä¸ªé‡è¦å‚æ•°ï¼š
- æ¨¡å¼ï¼šsingleï¼›tfservingï¼Œæ¥å†³å®šæ˜¯å•ç‹¬å¯åŠ¨ï¼Œè¿˜æ˜¯é…åˆtensorflow-servingæ–¹å¼å¯åŠ¨
- ç«¯å£ï¼šå¯¹å¤–æœåŠ¡çš„ç«¯å£

## å®¹å™¨å¯åŠ¨è„šæœ¬

ç„¶åï¼Œæˆ‘ä»¬å°±å¯ä»¥é’ˆå¯¹æˆ‘ä»¬ä¸åŒçš„æ¨¡å¼ï¼Œä¼ å…¥ä¸åŒçš„ç¯å¢ƒå˜é‡ï¼Œæ¥å¯åŠ¨å®¹å™¨äº†ã€‚

ç”±äºè¿™ç§æ–¹å¼ï¼Œéœ€è¦mountä¸åŒçš„æ–‡ä»¶å’Œæ–‡ä»¶å¤¹ï¼Œå¯¼è‡´ï¼Œdockerå¯åŠ¨çš„è„šæœ¬ä¹Ÿæœ‰ä¸åŒï¼Œä¸»è¦æ˜¯æŒ‚è½½ä¸åŒçš„dockerå®¹å™¨çš„ç›®å½•ï¼š
- å¯¹äºå•ç‹¬å¯åŠ¨çš„æ–¹å¼ï¼Œè¦æŒ‚è½½æ¨¡å‹æ–‡ä»¶ç›®å½•ã€æ—¥å¿—ç›®å½•ã€ä»¥åŠwebæœåŠ¡çš„é…ç½®æ–‡ä»¶ç›®å½•
- å¯¹äºé…åˆtensorflow-servingæ–¹å¼çš„å®¹å™¨å¯åŠ¨æ–¹å¼ï¼Œéœ€è¦æŒ‚è½½SavedModelæ¨¡å‹çš„ç›®å½•åˆ°tensorflow-servingçš„å®¹å™¨ä¸Š

å¥½ï¼Œå¯ä»¥å‚è€ƒ[docker.sh](https://github.com/piginzoo/ocr/blob/master/bin/docker.sh)ã€‚

# å®¹å™¨ç¼–æ’

åˆ°è¿™é‡Œï¼Œè²Œä¼¼ä¸€èµ·è¦ç»“æŸäº†ï¼Œå¯æ˜¯ï¼Œå¹¶æ²¡æœ‰ã€‚

æˆ‘ä»¬éœ€è¦æ”¾åˆ°ç”Ÿäº§ç¯å¢ƒï¼Œæ˜¯éœ€è¦æœåŠ¡ç¼–æ’çš„ï¼š

>[Docker Compose](https://yeasy.gitbooks.io/docker_practice/compose/introduction.html)å®šä¹‰å’Œè¿è¡Œå¤šä¸ªDockerå®¹å™¨çš„åº”ç”¨,å¤šä¸ªå®¹å™¨ç›¸äº’é…åˆæ¥å®ŒæˆæŸé¡¹ä»»åŠ¡çš„æƒ…å†µã€‚ä¾‹å¦‚è¦å®ç°ä¸€ä¸ª Web é¡¹ç›®ï¼Œé™¤äº† WebæœåŠ¡å®¹å™¨æœ¬èº«ï¼Œå¾€å¾€è¿˜éœ€è¦å†åŠ ä¸Šåç«¯çš„æ•°æ®åº“æœåŠ¡å®¹å™¨ï¼Œç”šè‡³è¿˜åŒ…æ‹¬è´Ÿè½½å‡è¡¡å®¹å™¨ç­‰ã€‚Compose æ°å¥½æ»¡è¶³äº†è¿™æ ·çš„éœ€æ±‚ã€‚å®ƒå…è®¸ç”¨æˆ·é€šè¿‡ä¸€ä¸ªå•ç‹¬çš„ docker-compose.yml æ¨¡æ¿æ–‡ä»¶ï¼ˆYAML æ ¼å¼ï¼‰æ¥å®šä¹‰ä¸€ç»„ç›¸å…³è”çš„åº”ç”¨å®¹å™¨ä¸ºä¸€ä¸ªé¡¹ç›®ï¼ˆprojectï¼‰ã€‚
æ¦‚å¿µï¼š
- æœåŠ¡ (service)ï¼šä¸€ä¸ªåº”ç”¨çš„å®¹å™¨ï¼Œå®é™…ä¸Šå¯ä»¥åŒ…æ‹¬è‹¥å¹²è¿è¡Œç›¸åŒé•œåƒçš„å®¹å™¨å®ä¾‹ã€‚
- é¡¹ç›® (project)ï¼šç”±ä¸€ç»„å…³è”çš„åº”ç”¨å®¹å™¨ç»„æˆçš„ä¸€ä¸ªå®Œæ•´ä¸šåŠ¡å•å…ƒï¼Œåœ¨ docker-compose.yml æ–‡ä»¶ä¸­å®šä¹‰ã€‚
ä¸€ä¸ªé¡¹ç›®å¯ä»¥ç”±å¤šä¸ªæœåŠ¡ï¼ˆå®¹å™¨ï¼‰å…³è”è€Œæˆï¼ŒCompose é¢å‘é¡¹ç›®è¿›è¡Œç®¡ç†ã€‚
â€œé¡¹ç›®æ˜¯å…³é”®ï¼ŒåŒ…å«å¤šä¸ªæœåŠ¡ï¼â€

å¥½ï¼Œé‚£å°±å¼€å§‹å†™docker-composeæ–‡ä»¶å§ã€‚

æˆ‘åˆ†æˆäº†2ä¸ªæ–‡ä»¶ï¼š[docker-compse-single.yml](https://github.com/piginzoo/ocr/blob/master/config/docker-compose-single.yml)å’Œ[docker-compse-tfserving.yml](https://github.com/piginzoo/ocr/blob/master/config/docker-compose-tfserving.yml)ã€‚åˆ†ä¸º2ä¸ªçš„åŸå› ï¼Œæ˜¯å› ä¸ºä¸¤ç§æ–¹å¼çš„å®¹å™¨å¯åŠ¨æ–¹å¼æ˜¯ä¸ä¸€æ ·çš„ï¼Œâ€œsingleæ–¹å¼â€å¯åŠ¨ä¸€ä¸ªå®¹å™¨å°±å¯ä»¥ï¼Œå°±æ˜¯webæœåŠ¡å®¹å™¨ï¼›è€Œâ€œtfservingæ–¹å¼â€ï¼Œè¦å¯åŠ¨WebæœåŠ¡å®¹å™¨ã€tensorflow-servingå®¹å™¨ï¼Œ2ä¸ªå®¹å™¨ã€‚è€Œä¸”ä¸¤ç§æ–¹å¼è¿˜è¦ä¸€äº›ä¸åŒçš„ç¯å¢ƒå˜é‡éœ€è¦ä¼ å…¥ï¼Œæ‰€ä»¥å†™æˆ2ä¸ªç¼–æ’æ–‡ä»¶ã€‚æœªæ¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œä¼šä¸»è¦ä½¿ç”¨â€œtfservingæ–¹å¼â€çš„ç¼–æ’æ–¹å¼ã€‚

# å®‰è£…æ­¥éª¤
è¿™é‡Œï¼ŒæŠŠæ•´ä¸ªçš„å®‰è£…æ­¥éª¤ï¼Œåˆ—å‡ºæ¥ï¼Œä¸ºåç»­éƒ¨ç½²æä¾›æ‰‹å†Œï¼š[Tensorflowå®˜ç½‘æä¾›çš„å‚è€ƒ](https://www.tensorflow.org/install/gpu)

æˆ‘ä»¬ä¸Šé¢è®¨è®ºè¿‡äº†ï¼Œåªéœ€è¦åœ¨å®¿ä¸»æœºä¸Šå®‰è£…GPUæ˜¾å¡é©±åŠ¨å³å¯ï¼Œå…¶ä»–çš„CUDA tookitã€cuDNNéƒ½ä¸éœ€è¦äº†ã€‚å¦å¤–å°±æ˜¯å®‰è£…ä¸€ä¸‹nivdia-docker:
- æ˜¾å¡é©±åŠ¨
- nivdia-docker

## å®‰è£…æ˜¾å¡é©±åŠ¨

1.ä¸‹è½½æ˜¾å¡é©±åŠ¨ï¼š[nvidiaå®˜ç½‘é©±åŠ¨ä¸‹è½½](https://www.nvidia.com/Download/index.aspx?lang=en-us),é€‰æ‹©ï¼šTesla/P/P40/P/P40/RHEL7/CUDA10.0ã€‚

è¿™é‡Œæœ‰ä¸ªå¿«æ·ä¸‹è½½é€šé“ï¼š[ä¸‹è½½åœ°å€](https://developer.download.nvidia.com/compute/cuda/repos/rhel7/x86_64/cuda-10-0-10.0.130-1.x86_64.rpm)ï¼›æˆ–è€…wgetç›´æ¥è·å¾—ï¼š

`wget https://developer.download.nvidia.com/compute/cuda/repos/rhel7/x86_64/cuda-10-0-10.0.130-1.x86_64.rpm`

>ä¸ºä½•è¦é€‰æ‹©CUDA10.0?
>åŸå› æ˜¯ï¼Œæˆ‘ä»¬çš„Dockeré‡‡ç”¨çš„æ˜¯tensorflow1.14ï¼Œè¿™ä¸ªç‰ˆæœ¬éœ€è¦åŒ¹é…CUDA10.0.
>Tensorflowç‰ˆæœ¬å’ŒCUDAç‰ˆæœ¬çš„å¯¹åº”å…³ç³»ï¼š[å¯¹åº”å…³ç³»è¯¦ç»†ä¿¡æ¯](https://www.tensorflow.org/install/source#tested_build_configurations)

2.å®‰è£…æ˜¾å¡é©±åŠ¨ï¼š
åœ¨Linuxï¼ˆæˆ‘ä»¬æ˜¯CentOS7)ä¸­å®‰è£…ï¼š[å‚è€ƒnvidiaå®˜ç½‘å®‰è£…é©±åŠ¨](https://docs.nvidia.com/cuda/cuda-installation-guide-linux/#axzz4VZnqTJ2A)

è¯¦ç»†æ­¥éª¤ï¼ˆå¤§è‡ªç„¶æ¬è¿å·¥ï¼Œè¯¦ç»†è¿˜æ˜¯å»å‚è€ƒ[å®˜ç½‘å®‰è£…æ­¥éª¤é“¾æ¥](https://docs.nvidia.com/cuda/cuda-installation-guide-linux/#axzz4VZnqTJ2A)ï¼‰ï¼š
- `lspci | grep -i nvidia`ï¼Œçœ‹çœ‹æ‚¨çš„æ˜¯ä»€ä¹ˆæ˜¾å¡
- `uname -m && cat /etc/*release`ï¼Œå»çœ‹çœ‹æ“ä½œç³»ç»Ÿä¿¡æ¯
- `gcc --version`ï¼Œç¡®å®šGCCç‰ˆæœ¬
- `sudo yum install kernel-devel-$(uname -r) kernel-headers-$(uname -r)`ï¼Œéœ€è¦å®‰è£…å¼€å‘devel-libs

å®‰è£…ï¼š
```
- subscription-manager repos --enable=rhel-7-server-optional-rpms
- rpm --install cuda-10-0-10.0.130-1.x86_64.rpm
- yum clean expire-cache
- yum install nvidia-driver-latest-dkms
- yum install cuda
```

## å®‰è£…Nvidia Docker

ä¸åŒäºæ™®é€šdockerï¼Œæˆ‘ä»¬éœ€è¦å®‰è£…ç”±[nvidiaå…¬å¸æä¾›çš„ç‰¹æ®Šç‰ˆæœ¬çš„docker](https://github.com/NVIDIA/nvidia-docker)æœåŠ¡ï¼š

è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š
```
$ distribution=$(. /etc/os-release;echo $ID$VERSION_ID)
$ curl -s -L https://nvidia.github.io/nvidia-docker/$distribution/nvidia-docker.repo | sudo tee /etc/yum.repos.d/nvidia-docker.repo
$ sudo yum install -y nvidia-container-toolkit
$ sudo systemctl restart docker
```

## åˆ¶ä½œåŸºå‡†Image

```
# åŸºäºtensorflow/tensorflow:1.14.0-gpu-py3ç”Ÿæˆä¸€ä¸ªåŸºç¡€é•œåƒ
# ä»–æ»¡è¶³äº†ï¼šnvidiaæ”¯æŒã€pytnon3æ”¯æŒã€ubuntuæ”¯æŒ

From tensorflow/tensorflow:1.14.0-gpu-py3

MAINTAINER piginzoo

ADD config/sources.list /etc/apt/sources.list

RUN apt-get update
RUN apt-get install -y libsm6
RUN apt-get install -y libxrender1
RUN apt-get install -y libxext-dev
RUN apt-get install -y language-pack-zh-hans

ENV LANG zh_CN.UTF-8
ENV LANGUAGE zh_CN:zh
ENV LC_ALL zh_CN.UTF-8

# å®‰è£…æ‰€éœ€è¦çš„ç¬¬ä¸‰æ–¹åŒ…
ADD ocr/requirements.txt /home/requirements.txt
RUN pip install -r /home/requirements.txt -i https://mirrors.aliyun.com/pypi/simple/
```

# æ€»ç»“

ç»ˆäºï¼Œè¿™äº‹å·®ä¸å¤šäº†ï¼Œæœ€åæ€»ç»“ä¸€ä¸‹ï¼Œä¸ºäº†è®©éƒ¨ç½²ä¸€ä¸ªå®Œæ•´çš„æ”¯æŒGPUTensorflowç¨‹åºä¸Šçº¿ï¼Œä½ éœ€è¦åšï¼š

- æ„å»ºä¸€ä¸ªåŸºç¡€é•œåƒï¼Œè®©å…¶æ”¯æŒGPUï¼Œæ”¯æŒtensorflow-gpuï¼Œå¹¶å®‰è£…å¥½å„ç§åŒ…
- æ„å»ºä½ çš„webå®¹å™¨ï¼Œç¼–è¯‘å¥½ctpnä¸­çš„c++åŠ¨æ€åº“ï¼Œä½¿ç”¨æœ¬åœ°å®‰è£…åŒ…æ–¹å¼éƒ¨ç½²å¥½ä»£ç 
- å®¹å™¨å¯åŠ¨é‡‡ç”¨ç¯å¢ƒå˜é‡çš„æ–¹å¼ä¼ å…¥éœ€è¦çš„åŠ¨æ€å‚æ•°ï¼Œå¹¶ä¸”ï¼Œmountå¥½å„è‡ªçš„ç›®å½•
- æœ€åä½¿ç”¨dockerç¼–æ’æœåŠ¡ï¼Œç»‘å®šå¥½å„è‡ªéœ€è¦çš„å†…å®¹




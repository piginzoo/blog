---
layout: post
title: 架个v2ray
category: tech
---

这几天墙貌似升级，之前的SS全部被封杀，没办法，只好v2ray一把了。把整个历程记录一下，以备今后架设使用。顺道感谢一下，万能的胖仔，为我提供技术支持。

先贴个文档，[简易版V2ray手册](https://toutyrater.github.io/)，说简易，其实也不简易，挺多的，耐着性子看完了。实在是没心情再看官方的document了，这个差不多就够了。

# 原理片

原理上，和SS一样，都是为了和墙大作战，不过，比SS更强大和复杂，所以可以更好地对抗墙：

```
简单来说，SS 功能单一，V2Ray 功能强大。听起来似乎有点贬低 SS呢？当然不！换一个角度来看，SS 简单好上手，V2Ray 复杂配置多。
```

我的理解，就是客户端建立一个到v2ray主机的通道，上面跑[VMess协议](https://toutyrater.github.io/basic/vmess.html)，然后到了服务器端解密解包，然后帮助路由出去，回来的包再按照这个路数回来即可。

```
{浏览器} <--(socks)--> {V2Ray 客户端 inbound <-> V2Ray 客户端 outbound} <--(VMess)-->  {V2Ray 服务器 inbound <-> V2Ray 服务器 outbound} <--(Freedom)--> {目标网站}
```

除了加密，就是伪装了，这个很赞，V2ray可以伪装成各类协议，比如伪装成一个web服务器，也可以伪装成用一个tcp的标准服务、STMP的流媒体、甚至是微信的视频服务器啥的，一堆选择，总有一款适合您。当然TLS支持是必须滴。

不过胖仔告诫说，如果犯懒使用tcp或者[KCP](https://toutyrater.github.io/advanced/mkcp.html)，就跟之前的SS没啥区别，就跟裸奔一样，一定要伪装成，TLS的Websocket服务器，这样，才可以躲避万恶的墙的扫描。最好再准备一个宣扬我党政策的大主页，就绝对安全了，哈哈。

# 服务端配置

我犯懒，直接谷歌了一个[教程](https://233v2.com/post/16/)，一键安装之，很不错，还有个shell菜单引导你，省去了配置修改config.json，不过，你最好还是提前通读一下[简易配置文档](https://toutyrater.github.io/)先。

我本来一键式用最简单的方式，也就是tcp，设置的，都没搞啥KCP协议，恩，很快就跑起来了，然后安装了V2RayX，通了，很高兴。（细节大家就读这个小哥哥的文档即可，还是写的很赞的）。

然而，胖仔恐吓我，说，这种方式跟裸奔没啥区别，必须要TLS+WebSocket方式，寻求终极安全。鉴于这两日被墙强奸的痛楚，就只好硬着头皮去鼓捣tls+ws方式。感谢热心似火的胖仔，给我提供了爽爽的[一键安装脚本](/assets/installtlscert.sh)，满心欢喜运行一把，fail了，细看，应该是因为胖仔这个是for Ubuntu的，我的是CentOS，没关系，读读脚本，自己搞定，否则，再去滋扰人家，多不好意思啊。

细看了一下，其实也不难，大致流程就是：
- 装个Nginx
- 申请个免费的TLS证书，改造自己的服务器成为https
- 然后把nginx的websocket请求代理给本地的v2ray的端口为10000的服务
- v2ray端配置成Webscoket+TLS方式即可

nginx就不用说了吧，yum直接搞定。

就是先调用~/.acme.sh去申请个证书，acme是啥，是一个免费提供TLS安全证书的脚本，细节也没兴趣搞了，感兴趣可以去看看[这篇](https://moe.best/tutorial/acme-le-wc.html)，恩，随便搜了一篇贴给你。

然后，胖仔的脚本帮助生成了一个SSL的配置，真好，省去的我这个SSL配置盲的工夫。

然后就差配置v2ray了，于是，我有启动小哥哥的配置脚本，菜单上一选，搞定。

好啦，重启v2ray、nginx服务，然后，去配置客户端喽。

# 客户端
我发现了2个客户端，一个是v2rayX，一个v2rayU，抱歉，都是for Mac的，如果您需要windows的，自行谷歌吧，哦不，自行百度吧。

客户端其实和服务器端没啥区别，你去[官网](https://github.com/v2ray/v2ray-core/releases)下载的话，其实，就是很对付的给你弄一个交叉编译版本，比如mac、windows版本而已，你还是去人肉编辑config.json，好变态，所以，v2rayX/v2rayU，就给你给套了个配置的壳子，好用多了。其实，底层还是包了个v2ray内核。

V2rayU，我没有使用，这里只说说V2RayX的设置吧，V2RayU自行对比设置吧。

## V2RayX的设置

[V2rayX](https://233v2.com/post/9/)很好用，而且[这篇文档](https://233v2.com/post/9/)也讲的很清楚，我就不贴图了，仔细阅读即可。我这里丹丹说说websocket+TSL的配置吧。

- Address：地址不能写IP了，要写一个域名，建议走一个info买的便宜域名，别用国内自己常用的域名，防止喝茶
- Port：端口，恩，443，TLS嘛
- Network：这里选择Websocket即可
- 然后点开“transport setting...”，配置2个地方：
- 1. Websocket
	path是你服务器上的websocket对外服务的路径，比如/mymsg
	在"header"里面输入{"Host" : "xxx.yourdomain.info"},恩，你绑的域名
- 2. TLS
	勾选Use TLS，然后在Server Name处填入"xxx.yourdomain.info"

恩，差不多了，然后把log level改成debug，暗中观察日志即可，有错排错，谷歌之即可。

# 遇到的一些问题

- 别忘了绑定的主机到一个域名，恩，买个info的，防止喝茶
- nginx配置过程中，主要是websocket服务要绑定个路径，这个其实可以通过chrome浏览器就可以测试（其实，万恶的墙也是这样来侦测你的），方便排查
- 没事就观察v2rayx的客户端日志、v2ray服务器端日志、nginx日志，然后股沟之，一般问题都轻松搞定

# 最后

这年头，翻出去不容易，口袋越收越紧了，年轻淫们，可以人肉翻就赶紧翻吧。我呢，为了看看油管，翻翻股沟，唉，这年头，生活、学习都不易啊。